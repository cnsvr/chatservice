<!DOCTYPE html>
<html lang="en">
<head th:replace="~{fragments/header :: header}"><title></title></head>
<body>
<div class="wrapper">

    <!-- ========== Topbar Start ========== -->
    <div th:replace="~{fragments/layout :: topbar}"></div>
    <!-- ========== Topbar End ========== -->

    <!-- ========== Left Sidebar Start ========== -->
    <div th:replace="~{fragments/layout :: sidebar}"></div>
    <!-- ========== Left Sidebar End ========== -->

    <div class="content-page">
        <div class="content">
            <!-- Start Content-->
            <div class="container-fluid">
                <h1 class="display-6">All Rooms</h1>
                <div class="row-12">
                    <table class="table table-striped table-centered mb-0">
                        <thead>
                        <tr>
                            <th>Room ID</th>
                            <th>Active Users</th>
                            <th>Created At</th>
                            <th>Action</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="room : ${rooms}">
                            <td class="table-user" th:text="${room.getRoomID()}"></td>
                            <td th:text="${room.getMembers().size()}"></td>
                            <td th:text="${#dates.format(room.getCreatedAt(), 'dd/MM/yyyy HH:mm:ss')}"></td>
                            <td class="table-action">
                                <button type="button" class="btn btn-success rounded-pill" id="join-room"
                                        th:data-target="${room.getRoomID()}" onclick="joinRoom(this)">
                                    Join
                                </button>

                            </td>
                        </tr>
                        </tbody>
                    </table>

                </div>

            </div>
            <!-- container -->
        </div>
    </div>
    <!-- content -->

    <!-- Footer Start -->
    <div th:replace="~{fragments/layout :: footer}"></div>
    <!-- end Footer -->
</div>
</body>

<script type="module">
    import ws from "/js/web-socket-client.js";

    const usernames = ["mehmet", "leyla", "ali", "ayse", "fatma", "huseyin", "zeynep", "ahmet", "aylin", "cem"];
    ws.updateUsername(usernames[Math.floor(Math.random() * usernames.length)]);
    ws.connect();

    function joinRoom(button) {
        const target = button.getAttribute('data-target');

        ws.subscribe('/user/topic/join-channel', function (message) {
            console.log("message", message.body)
            const messageBody = JSON.parse(message.body);
            window.location.href = '/admin/messages/room/' + target + '/' + messageBody['channelID']
        });

        const message = {
            target: target,
            targetChannelType: 'ROOM',
            hidden: "false",
            persistence: "false"
        };

        ws.send('/app/join-channel', JSON.stringify(message));
    }

    window.joinRoom = joinRoom;
</script>

</html>